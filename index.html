<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Mini RPG Pixel - Chefão com Dialogo</title>
<style>
canvas { 
    border: 2px solid black; 
    image-rendering: pixelated; 
    background: #88cc88;
}
.dialog-box {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    width: 400px;
    padding: 10px;
    background: rgba(0,0,0,0.8);
    color: white;
    font-family: monospace;
    border: 2px solid white;
    border-radius: 10px;
    display: none;
}
.dialog-text {
    margin-bottom: 5px;
}
.dialog-hint {
    font-size: 12px;
    text-align: right;
    opacity: 0.7;
}
</style>
</head>
<body>
<canvas id="gameCanvas" width="640" height="480"></canvas>
<div id="dialog" class="dialog-box">
    <div id="dialogText" class="dialog-text"></div>
    <div class="dialog-hint">Pressione Espaço para continuar</div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const dialogBox = document.getElementById('dialog');
const dialogText = document.getElementById('dialogText');

const tileSize = 32;

// Sprites
const sprites = {
    player: new Image(),
    tree: new Image(),
    grass: new Image(),
    dirt: new Image(),
    enemy: new Image(),
    boss: new Image(),
    sword: new Image()
};

// URLs dos sprites
sprites.player.src = 'https://i.pinimg.com/originals/21/e6/2a/21e62a01a88c3d27aec6d6a7d244b94a.png';
sprites.tree.src = 'https://static.wikia.nocookie.net/farm-keeper/images/8/88/Tree_Tile.png/revision/latest?cb=20230830173852';
sprites.grass.src = 'https://2.bp.blogspot.com/-3-bkBLwA_Bk/VaTNgW4XoEI/AAAAAAAAE_8/hHO-ZQz83OI/s1600/tile_grass_v01bs.png';
sprites.dirt.src = 'https://media.craiyon.com/2023-10-15/6752a7e264634ae1bd9dc5a01b5635af.webp';
sprites.enemy.src = 'https://img.itch.zone/aW1hZ2UvMjAxMzg1Ny8xMTg0MjUwMi5wbmc=/347x500/Rl27id.png';
sprites.boss.src = 'https://w7.pngwing.com/pngs/865/836/png-transparent-world-of-warcraft-the-burning-crusade-boss-pixel-art-minecraft-minecraft-chibi-video-game-boss.png';
sprites.sword.src = 'https://static.vecteezy.com/system/resources/previews/019/040/578/non_2x/an-8-bit-retro-styled-pixel-art-illustration-of-a-wooden-sword-free-png.png';

// Jogador
let player = { x: 1, y: 1, angle: 0, alive: true, hp: 3, facingLeft:false };

// Inimigos padrão
let enemies = [
    { x: 10, y: 7, alive: true, hp: 2 },
    { x: 5, y: 3, alive: true, hp: 2 },
    { x: 14, y: 5, alive: true, hp: 2 },
    { x: 8, y: 10, alive: true, hp: 2 }
];

// Chefão
let boss = { x: 10, y: 7, alive:false, hp: 5 };

// Contador de inimigos mortos
let enemiesKilled = 0;

// Dialogo
let dialogs = ["Olá.... Parece que voce está perdido.","test"];
let dialogIndex = 0;
let dialogActive = false;

// Mapa 20x15
const map = [
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,1,1,1,0,0,0,0,0,0,0,1,1,1,0,0,0,0],
    [0,2,0,1,0,1,0,0,0,0,0,1,0,1,0,1,0,2,0,0],
    [0,0,0,1,0,1,0,0,2,0,2,0,0,1,0,1,0,0,0,0],
    [0,0,0,1,0,1,1,1,1,0,1,1,1,1,0,1,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0],
    [0,1,1,1,0,0,0,0,1,0,2,0,0,0,1,1,1,0,0,0],
    [0,1,0,1,0,2,0,0,1,0,0,0,2,0,1,0,1,0,0,0],
    [0,1,0,1,0,0,0,0,1,1,1,1,0,0,1,0,1,0,0,0],
    [0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,1,1,1,1,1,0,0,2,0,0,1,1,1,1,0,0,0,0],
    [0,0,1,0,0,0,1,0,0,0,0,0,1,0,0,1,0,0,0,0],
    [0,0,1,0,2,0,1,1,1,0,1,1,1,0,2,1,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
];

// Teclas pressionadas
let keys = {};

// Velocidade do jogador
let moveCooldown = 10; 
let moveCounter = 0;

// Velocidade dos monstros (diminuída)
let enemyMoveCooldown = 60;
let enemyMoveCounter = 0;

// Ataque com swing
let attackSwing = {
    active: false,
    frame: 0,
    totalFrames: 40,   // mais lento
    startAngle: Math.PI/2,  // 90°
    endAngle: 3*Math.PI/2,  // 270°
    angle: 0
};

// Funções de desenho
function drawMap() {
    for(let y=0;y<map.length;y++){
        for(let x=0;x<map[y].length;x++){
            let tile = map[y][x];
            switch(tile){
                case 0: ctx.drawImage(sprites.grass,x*tileSize,y*tileSize,tileSize,tileSize); break;
                case 1: ctx.drawImage(sprites.dirt,x*tileSize,y*tileSize,tileSize,tileSize); break;
                case 2: ctx.drawImage(sprites.tree,x*tileSize,y*tileSize,tileSize,tileSize); break;
            }
        }
    }
}

function drawPlayer() {
    ctx.save();
    ctx.translate(player.x*tileSize + tileSize/2, player.y*tileSize + tileSize/2);
    if(player.facingLeft) ctx.scale(-1,1);
    ctx.rotate(player.angle);
    ctx.drawImage(sprites.player, -tileSize/2, -tileSize/2, tileSize, tileSize);
    ctx.restore();
}

function drawEnemies() {
    enemies.forEach(e=>{
        if(e.alive) ctx.drawImage(sprites.enemy, e.x*tileSize, e.y*tileSize, tileSize, tileSize);
    });
}

function drawBoss() {
    if(boss.alive) ctx.drawImage(sprites.boss, boss.x*tileSize, boss.y*tileSize, tileSize, tileSize);
}

function drawSwordSwing() {
    if(!attackSwing.active) return;
    const distance = 1;
    const targetX = player.x + Math.round(Math.cos(player.angle) * distance);
    const targetY = player.y + Math.round(Math.sin(player.angle) * distance);
    const pivotX = targetX*tileSize;      
    const pivotY = targetY*tileSize + tileSize;
    attackSwing.angle = attackSwing.startAngle + 
        ((attackSwing.frame / attackSwing.totalFrames) * (attackSwing.endAngle - attackSwing.startAngle));
    ctx.save();
    ctx.translate(pivotX, pivotY);
    ctx.rotate(attackSwing.angle);
    ctx.drawImage(sprites.sword, 0, -tileSize, tileSize, tileSize);
    ctx.restore();
    attackSwing.frame++;
    if(attackSwing.frame >= attackSwing.totalFrames) attackSwing.active = false;

    // Colisão com inimigos
    enemies.forEach(e=>{
        if(e.alive && e.x===targetX && e.y===targetY){
            e.hp--;
            if(e.hp<=0){
                e.alive=false;
                enemiesKilled++;
                console.log("Inimigo morto! Total:", enemiesKilled);
                if(enemiesKilled>=4 && !boss.alive){
                    boss.alive=true;
                    startDialog();
                }
            }
        }
    });
    if(boss.alive && boss.x===targetX && boss.y===targetY){
        boss.hp--;
        console.log("Chefão atingido! HP:", boss.hp);
        if(boss.hp<=0) boss.alive=false;
    }
}

// Caixa de diálogo
function startDialog(){
    dialogActive=true;
    dialogIndex=0;
    dialogBox.style.display="block";
    dialogText.textContent = dialogs[dialogIndex];
}

function nextDialog(){
    dialogIndex++;
    if(dialogIndex>=dialogs.length){
        dialogActive=false;
        dialogBox.style.display="none";
    } else {
        dialogText.textContent = dialogs[dialogIndex];
    }
}

// Atualiza tela
function update() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    drawMap();
    drawEnemies();
    drawBoss();
    drawPlayer();
    drawSwordSwing();
    ctx.fillStyle="black";
    ctx.font="16px Arial";
    ctx.fillText("Inimigos mortos: "+enemiesKilled,10,20);
}

// Movimento jogador
function movePlayer() {
    moveCounter++;
    if(moveCounter < moveCooldown) return;
    moveCounter=0;
    if(dialogActive) return; // travar movimento durante dialogo

    let dx=0, dy=0;
    if(keys['ArrowUp']) dy--;
    if(keys['ArrowDown']) dy++;
    if(keys['ArrowLeft']) dx--;
    if(keys['ArrowRight']) dx++;

    player.facingLeft = dx<0;
    if(dx!==0 || dy!==0) player.angle = Math.atan2(dy, dx);

    let newX = player.x + dx;
    let newY = player.y + dy;

    if(map[newY]!==undefined && map[newY][newX]!==2){
        player.x=newX;
        player.y=newY;
    }
}

// Movimento inimigos
function moveEnemies() {
    enemyMoveCounter++;
    if(enemyMoveCounter<enemyMoveCooldown) return;
    enemyMoveCounter=0;

    enemies.forEach(e=>{
        if(!e.alive) return;
        const dirs = [
            {dx:-1, dy:0}, {dx:1, dy:0}, {dx:0, dy:-1}, {dx:0, dy:1},
            {dx:-1, dy:-1},{dx:1, dy:-1},{dx:-1, dy:1},{dx:1, dy:1}
        ];
        let dir = dirs[Math.floor(Math.random()*dirs.length)];
        let newX = e.x + dir.dx;
        let newY = e.y + dir.dy;
        if(map[newY]!==undefined && map[newY][newX]!==2) {
            e.x=newX; e.y=newY;
        }
    });
}

// Inicia ataque
function startAttack() {
    if(!attackSwing.active) attackSwing.active=true;
    attackSwing.frame=0;
}

// Loop principal
function gameLoop() {
    movePlayer();
    moveEnemies();
    update();
    requestAnimationFrame(gameLoop);
}

// Controles
window.addEventListener('keydown', (e)=>{
    keys[e.key]=true;
    if(e.key===' ') {
        if(dialogActive) nextDialog();
        else startAttack();
    }
});
window.addEventListener('keyup', (e)=>{ keys[e.key]=false; });

// Espera sprites carregarem
let loaded=0;
for(let key in sprites){
    sprites[key].onload = ()=>{
        loaded++;
        if(loaded===Object.keys(sprites).length){
            gameLoop();
        }
    };
}
</script>
</body>
</html>

